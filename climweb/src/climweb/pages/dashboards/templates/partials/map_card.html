{% load wagtailiconchooser_tags wagtailcore_tags %}
<div class="card elevation-1">
    <header class="card-header elevation-0" style="align-items: center;">
        <p class="card-header-title">
            {{ map.title}}
        </p>

        {% if map.map_type == 'single' %}
            {% if map_layers.0.value.dataset.metadata %}
            <button class="card-header-icon js-modal-trigger" data-target="modal-{{ section_index }}-{{ index }}-{{ block_index }}">
                <div class="icon is-small">{% svg_icon "info-circle" %}</div>
            </button>
            {% endif %}

            {% if map_layers.0.value.dataset.published and map_layers.0.value.dataset.public %}
            <a class="card-header-icon button is-small is-dark is-rounded" href="{{ map.mapviewer_map_url }}" target="_blank" rel="noopener" style="border-radius: 20px !important; ">
                <span class="icon is-small">{% svg_icon "layer-group" %}</span><span>Mapviewer</span></a>
            {% endif %}

        {% elif map.map_type == 'comparison' %}

            <!-- Mapviewer button for comparison maps - show if both layers are published and public -->
            {% if map_layers.0.value.dataset.published and map_layers.0.value.dataset.public and map_layers.1.value.dataset.published and map_layers.1.value.dataset.public %}
            <div class="dropdown is-hoverable">
                <div class="dropdown-trigger">
                    <button class="card-header-icon button is-small is-dark is-rounded" style="border-radius: 20px !important;">
                        <span class="icon is-small">{% svg_icon "layer-group" %}</span>
                        <span>Mapviewer</span>
                    </button>
                </div>
                <div class="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        <a class="dropdown-item" href="{{ map.mapviewer_map_url_before }}" target="_blank" rel="noopener">
                            <span class="icon is-small">{% svg_icon "layer-group" %}</span>
                            <span>{{ map_layers.0.value.dataset.title|truncatechars:25 }}</span>
                        </a>
                        <a class="dropdown-item" href="{{ map.mapviewer_map_url_after }}" target="_blank" rel="noopener">
                            <span class="icon is-small">{% svg_icon "layer-group" %}</span>
                            <span>{{ map_layers.1.value.dataset.title|truncatechars:25 }}</span>
                        </a>
                        <hr class="dropdown-divider">
                        <a class="dropdown-item" href="{{ map.mapviewer_comparison_url }}" target="_blank" rel="noopener">
                            <span><b>Compare Both</b></span>
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </header>

    <div class="card-content">
        {% if map.map_type == "single" %}

            <div
                class="map-container"
                id="map-{{ section_index }}-{{ index }}-{{ block_index }}"
                data-map-type="{{ map.map_type }}"
                data-tilejson="{{ map_snippet.datasetsurl }}{{ map.map_layer.0.value.dataset.id }}"
                data-dataset="{{ map.map_layer.0.value.dataset.id }}"
                data-layer="{{ map.map_layer.0.value.id }}"
                data-title="{{ map.title }}"
                data-geostore-id="{{ map.geostore_id }}"
                data-gid0="{{ map.gid0|default_if_none:'' }}"
                data-gid1="{{ map.gid1|default_if_none:'' }}"
                data-gid2="{{ map.gid2|default_if_none:'' }}"
                data-date-format="{{ map.map_layer.0.value.date_format }}"
                data-layer-type="{% if map.map_layer.0.block_type == 'raster_file_layer' %}raster_file{% elif map.map_layer.0.block_type == 'wms_layer' %}wms{% elif map.map_layer.0.block_type == 'vector_tile_layer' %}vector_tile{% elif map.map_layer.0.block_type == 'raster_tile_layer' %}raster_tile{% endif %}"
            >
            
            </div>
            <div
                    class="c-legend-type-choropleth"
                    style="
                        position: absolute;
                        bottom: 20px;
                        left: 10px;
                        background: rgb(71 71 71 / 89%);
                        padding: 0px 40px 0px 5px;
                        color:#e7e7e7;
                        border-radius: 6px;
                        font-size: 14px;
                        z-index: 20;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                        display: none;
                    "
                    id="legend-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                ></div>
            
        {% elif map.map_type == "comparison" %}
            <div class="comparison-maps" id="comparison-map-{{ section_index }}-{{ index }}-{{ block_index }}" style="min-height: 500px;">
                <div
                    class="map-container"
                    id="before-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                    data-map-type="{{ map.map_type }}"
                    data-tilejson="{{ map_snippet.datasetsurl }}{{ map.map_layer.0.value.dataset.id }}"
                    data-dataset="{{ map.map_layer.0.value.dataset.id }}"
                    data-layer="{{ map.map_layer.0.value.id }}"
                    data-title="{{ map.title }}"
                    data-geostore-id="{{ map.geostore_id }}"
                    data-gid0="{{ map.gid0|default_if_none:'' }}"
                    data-gid1="{{ map.gid1|default_if_none:'' }}"
                    data-gid2="{{ map.gid2|default_if_none:'' }}"
                    data-date-format="{{ map.map_layer.0.value.date_format }}"
                    data-layer-type="{% if map.map_layer.0.block_type == 'raster_file_layer' %}raster_file{% elif map.map_layer.0.block_type == 'wms_layer' %}wms{% elif map.map_layer.0.block_type == 'vector_tile_layer' %}vector_tile{% elif map.map_layer.0.block_type == 'raster_tile_layer' %}raster_tile{% endif %}"
                >
                </div>
                <div
                    class="c-legend-type-choropleth"
                    style="
                        position: absolute;
                        top: 20px;
                        left: 10px;
                        background: rgb(71 71 71 / 89%);
                        color:#e7e7e7;
                        padding: 0px 40px 0px 5px;
                        border-radius: 6px;
                        font-size: 14px;
                        z-index: 20;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                        display: none;
                    "
                    id="legend-before-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                ></div>
                <div
                    class="map-container"
                    id="after-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                    data-map-type="{{ map.map_type }}"
                    data-tilejson="{{ map_snippet.datasetsurl }}{{ map.map_layer.1.value.dataset.id }}"
                    data-dataset="{{ map.map_layer.1.value.dataset.id }}"
                    data-layer="{{ map.map_layer.1.value.id }}"
                    data-title="{{ map.title }}"
                    data-geostore-id="{{ map.geostore_id }}"
                    data-gid0="{{ map.gid0|default_if_none:'' }}"
                    data-gid1="{{ map.gid1|default_if_none:'' }}"
                    data-gid2="{{ map.gid2|default_if_none:'' }}"
                    data-date-format="{{ map.map_layer.1.value.date_format }}"
                    data-layer-type="{% if map.map_layer.1.block_type == 'raster_file_layer' %}raster_file{% elif map.map_layer.1.block_type == 'wms_layer' %}wms{% elif map.map_layer.1.block_type == 'vector_tile_layer' %}vector_tile{% elif map.map_layer.1.block_type == 'raster_tile_layer' %}raster_tile{% endif %}"
                >
            </div>
            
            <div
                    class="c-legend-type-choropleth"
                    style="
                        position: absolute;
                        top: 20px;
                        right: 10px;
                        background: rgb(71 71 71 / 89%);
                        color:#e7e7e7;
                        padding: 0px 40px 0px 5px;
                        border-radius: 6px;
                        font-size: 14px;
                        z-index: 20;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                        display: none;
                    "
                    id="legend-after-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                ></div>
            </div>
        {% endif %}
    </div>

    <footer class="card-footer" style="position: relative;">
        {% if map.map_type == "single" %}
            {% if map.map_layer.0.value.dataset.multi_temporal %}
            <div class="m-2" style="width: 100%">
                <input
                    class="datepicker-input input is-small"
                    type="text"
                    placeholder="Select Date.."
                    id="mapdate-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                    data-date-format="{{ map_layers.0.value.date_format }}"
                />
                {% if map_layers.0.value.date_format == "yyyy-MM-dd HH:mm" %}
                <select
                    class="timepicker-select input is-small"
                    id="maptime-map-{{ section_index }}-{{ index }}-{{ block_index }}">
                </select>
                {% endif %}
                <div class="params" id="paramsContainer-map-{{ section_index }}-{{ index }}-{{ block_index }}"></div>
            </div>
            {% endif %}
        {% elif map.map_type == "comparison" %}
            <div class="m-2 before-date" style="width: 100%">
                <label style="font-size: 14px; font-weight: 700; color: #4a4a4a;" for="mapdate-before-map-{{ section_index }}-{{ index }}-{{ block_index }}">{{map_layers.0.value.dataset.title}}</label>
                
                {% if map.map_layer.0.value.dataset.multi_temporal %}
                <input
                    class="datepicker-input input is-small"
                    type="text"
                    placeholder="Select Date.."
                    id="mapdate-before-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                    data-date-format="{{ map_layers.0.value.date_format }}"
                />
                {% if map_layers.0.value.date_format == "yyyy-MM-dd HH:mm" %}
                <select
                    class="timepicker-select input is-small"
                    id="maptime-before-map-{{ section_index }}-{{ index }}-{{ block_index }}">
                </select>
                {% endif %}
                <div class="params" id="paramsContainer-before-map-{{ section_index }}-{{ index }}-{{ block_index }}"></div>
                {% endif %}

            </div>

            <div class="m-2 after-date" style="width: 100%">
                <label style="font-size: 14px; font-weight: 700; color: #4a4a4a;" for="mapdate-after-map-{{ section_index }}-{{ index }}-{{ block_index }}">{{map_layers.1.value.dataset.title}}</label>
                {% if map.map_layer.1.value.dataset.multi_temporal %}
                <input
                    class="datepicker-input input is-small"
                    type="text"
                    placeholder="Select Date.."
                    id="mapdate-after-map-{{ section_index }}-{{ index }}-{{ block_index }}"
                    data-date-format="{{ map_layers.1.value.date_format }}"
                />
                {% if map_layers.1.value.date_format == "yyyy-MM-dd HH:mm" %}
                <select
                    class="timepicker-select input is-small"
                    id="maptime-after-map-{{ section_index }}-{{ index }}-{{ block_index }}">
                </select>
                {% endif %}
                <div class="params" id="paramsContainer-after-map-{{ section_index }}-{{ index }}-{{ block_index }}"></div>
                {% endif %}
            </div>
        {% endif %}
    </footer>
</div>

{% if map.map_type == 'single' %}
    {% include "partials/modal.html" with metadata=map_layers.0.value.dataset.metadata section=section_index index=index block_index=block_index %}
{% endif %}