{% load wagtailcore_tags static nmhs_cms_tags %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/bulma-calendar.min.css' %}">
{% endblock extra_css %}

<div class="dashboard-charts">
    {% render_charts self.charts_block section_index=section %}
</div>

{% block extra_js %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="{% static 'js/bulma-calendar.min.js' %}"></script>
<script>
    function formatDateTime(datetimeString) {
        const date = new Date(datetimeString);
        const day = date.getDate();
        const month = date.toLocaleString("default", { month: "long" });
        const year = date.getFullYear();
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");

        return `${day} ${month} ${year}<br>${hours}:${minutes}`;
    }
    document.addEventListener("DOMContentLoaded", function () {
        document
            .querySelectorAll(".chart-container")
            .forEach(function (container) {
                const layerId = container.dataset.layerId;
                const adminCode = container.dataset.adminCode;
                const chartId = container.id;

                if (!layerId || !adminCode) return;

                let geostoreId = null;
                let oldestDate = null;

                // Step 1: Get geostore_id
                fetch(`/api/geostore/admin/${adminCode}?thresh=0.005`)
                    .then((res) => res.json())
                    .then((geo) => {
                        geostoreId = geo?.id;
                        if (!geostoreId)
                            throw new Error("Geostore ID not found");

                        // Step 2: Get timestamps from tiles.json
                        return fetch(`/api/raster/${layerId}/tiles.json`);
                    })
                    .then((res) => res.json())
                    .then((tileJson) => {
                        const timestamps = tileJson?.timestamps || [];
                        if (!timestamps.length)
                            throw new Error("No timestamps available");

                        oldestDate = timestamps[timestamps.length - 1]; // Pick the earliest timestamp

                        // Step 3: Fetch timeseries data with oldest date
                        const timeseriesUrl = `/api/raster-data/geostore/timeseries/${layerId}?geostore_id=${geostoreId}&value_type=mean&time_from=${oldestDate}`;
                        return fetch(timeseriesUrl);
                    })
                    .then((res) => res.json())
                    .then((data) => {
                        const timestamps =
                            data.map((d) => {
                                return d.date;
                            }) || [];

                        const values =
                            data.map((d) => Math.round(d.value * 100) / 100) ||
                            [];

                        Highcharts.chart(chartId, {
                            chart: {
                                type: container.dataset.type || "line",
                                backgroundColor: "transparent",
                                spacingTop: 40,
                            },
                            title: { text: null },
                            credits: {
                                enabled: false,
                            },
                            xAxis: {
                                categories: timestamps,
                                labels: {
                                    formatter: function () {
                                        return formatDateTime(this.value);
                                    },
                                },
                            },
                            yAxis: {
                                title: { text: container.dataset.unit },
                            },
                            series: [
                                {
                                    name: container.dataset.title,
                                    color: container.dataset.color,
                                    data: values,
                                },
                            ],
                            tooltip: {
                                formatter: function () {
                                    return `
                <b>${this.series.name}</b><br>
                ${formatDateTime(this.x)}<br>
                <b>${this.y.toFixed(2)}</b> ${this.series.options.unit || ""}
                `;
                                },
                            },
                        });
                    })
                    .catch((err) => {
                        console.error("Chart load error:", err);
                        container.innerHTML = `<p style="color:red;">Error loading chart</p>`;
                    });
            });
    });

    // Initialize all input of date type.
    let data_calendars = bulmaCalendar.attach('[type="date"]', options);

    // Loop on each calendar initialized
    data_calendars.forEach(calendar => {
        // Add listener to select event
        calendar.on('select', date => {
            console.log(date);
        });
    });

    // To access to bulmaCalendar instance of an element
    const element = document.querySelector('#my-element');
    if (element) {
        // bulmaCalendar instance is available as element.bulmaCalendar
        element.bulmaCalendar.on('select', datepicker => {
            console.log(datepicker.data.value());
        });
    }
</script>

{% endblock extra_js %}
